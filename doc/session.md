
##Сессии

###Основы

Для работы с сессией Knee предоставляет класс `Session`.

Разработчику предлагается три варианта хранение данных.

* **file** — Данные сессии хранятся в файлах;
* **database** — Данные сессии хранятся в базе данных;
* **memcached** — Данные сессии хранятся в кэше с использованием memory cache daemon Memcached.

Приступая к работе с сессией, нужно настроить некоторые параметры, которые находятся в файле конфигурации `/app/configs/session.php`.

* **driver** — название драйвера сессии;
* **table** — название таблицы для хранения данных сессии, если выбран драйвер database;
* **expire** — время жизни сессии без действия. Задается в формате (N sec, N min, N hour, N day, N month, N year), где N это число;
* **path** — путь, на который будет установлен файл Cookie с идентификатором сессии;
* **domain** — домен, на который будет установлен файл Cookie с идентификатором сессии;
* **secure** — http или https;
* **locking** — включение/отключение механизма блокировки;

Если используется драйвер для хранения сессии в базе данных, то должна быть создана соответствующая таблица.

```sql
CREATE TABLE IF NOT EXISTS `session` (
`session_id` varchar(32) NOT NULL,
`session_create_date` int(10) unsigned NOT NULL,
`session_update_date` int(10) unsigned NOT NULL,
`session_data` text NOT NULL,
PRIMARY KEY (`session_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

Механизм работы с данными сессии в Knee поддерживает блокировки во всех драйверах.
Блокировки нужны для ограничения одновременного доступа к данным двумя или более скриптами.

Например, при загрузки страницы отправляются несколько запросов Ajax которые работают с данными сессии. 
Если не использовать блокировки, то данные сессии будут потеряны или не верны.
Корректная блокировка данных действует, только если пользователь уже имеет идентификатор сессии. 
Иначе одновременно запущенные скрипты будут думать, что пользователь ещё не создал сессии, и каждый создаст новую сессию и её идентификатор.
Что бы этого не происходило, требуется заранее создать сессию пользователя. 

###Доступ

Класс `Session` имеет ряд полезных методов для проведения манипуляций с данными сессии.

####Запись данных в сессию

```php
Session::set('name', 'Jack');
```

####Получение данных сессии

```php
Session::get('name');
```

В случае если данных с таким ключом не существует, метод вернет `null`.

####Удаление данных

```php
Session::del('name');
```

####Удаление сессии (Дестрой)

```php
Session::destroy();
```

####Проверка на существование данных в сессии

```php
Session::exists('name');
```

####Генерация и получение случайного идентификатора

```php
Session::token(); // r3fpd7juebidqmbnbi28wmeq4lvhjnvq 
```

Например такой токен можно использовать для предотвращения CSRF атак.

####Старт сессии

По умолчанию старт сессии задан в файле `/app/settings/`.

```php
Session::start();
```

А завершение работы и сохранение данных происходит автоматически во время завершения работы скрипта.

Но вы можете открывать и закрывать сессию в ручном режиме, например, если вы ходите быстро что-то записать в сессию и снять блокировку.

```php
Session::start();

Session::set('name', 'Jack');

Session::end();
```

Это достаточно индивидуальный подход, т.к. за место траты времени на ожидание снятия блокировок другими скриптами, вы будите тратить его на старт сессии и чтения данных.

Например, такой подход будет полезен, если у вас есть скрипт, который очень долго выполняется и проще прочитать данные сессии несколько раз вручную, чем создавать очередь ожидания на снятие блокировки.

